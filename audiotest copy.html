<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compact Real Waveform Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <style>
    .modal-right {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 16px;
      width: 100%;
      max-width: 600px;
      box-sizing: border-box;
    }

    .howler-audio-player {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    .howler-button {
      background: #111;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      align-self: flex-start;
    }
    .howler-button:hover { background: #333; }

    .howler-canvas {
      width: 100%;
      height: 28px;
      border-radius: 4px;
      cursor: pointer;
    }

    .howler-time {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #666;
    }

    .howler-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .howler-input[type="range"] {
      flex: 1;
      cursor: pointer;
      height: 4px;
    }

    .transcript {
      font-size: 14px;
      color: #333;
      margin-top: 12px;
      line-height: 1.5;
    }

    @media (max-width: 480px) {
      .howler-audio-player {
        padding: 8px;
      }
      .howler-button {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="modal-right">
    <div class="howler-audio-player">
      <button id="howler-playPauseBtn" class="howler-button">‚ñ∂Ô∏è Play</button>
      <canvas id="howler-waveform" class=".howler-canvas"></canvas>
      <div class="howler-time">
        <span id="howler-currentTime">0:00</span>
        <span id="howler-duration">0:00</span>
      </div>
      <div class="howler-controls">
        <label>üîä</label>
        <input type="range" id="volume" min="0" max="1" step="0.05" value="1" class="howler-input">
        <label>‚è©</label>
        <input type="range" id="speed" min="0.5" max="2" step="0.05" value="1" class="howler-input">
      </div>
    </div>

    <div class="transcript">
      <p>
        This is the transcript of the audio. It appears below the player on the right side of the modal.
        The waveform above accurately represents the sound.
      </p>
    </div>
  </div>

  <script>
    const srcUrl = "./assets/audio/audio5-1.mp3";
    const playPauseBtn = document.getElementById("howler-playPauseBtn");
    const currentTimeEl = document.getElementById("howler-currentTime");
    const durationEl = document.getElementById("howler-duration");
    const volumeSlider = document.getElementById("howler-volume");
    const speedSlider = document.getElementById("howler-speed");
    const canvas = document.getElementById("howler-waveform");
    const ctx = canvas.getContext("2d");

    let peaks = [];
    let progressInterval;

    // Initialize Howler
    const sound = new Howl({
      src: [srcUrl],
      html5: true,
      onplay: updateProgress,
      onseek: updateProgress,
      onload: () => {
        durationEl.textContent = formatTime(sound.duration());
        if (peaks.length === 0) generateWaveform(srcUrl);
      }
    });

    // Format time helper
    const formatTime = (secs) => {
      const m = Math.floor(secs / 60);
      const s = Math.floor(secs % 60).toString().padStart(2, "0");
      return `${m}:${s}`;
    };

    // Resize canvas
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      drawWaveform(0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // Generate waveform from real audio data
    async function generateWaveform(url) {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

      const rawData = audioBuffer.getChannelData(0);
      const samples = 150; // fewer samples = smoother waveform
      const blockSize = Math.floor(rawData.length / samples);
      peaks = [];

      for (let i = 0; i < samples; i++) {
        let sum = 0;
        for (let j = 0; j < blockSize; j++) {
          sum += Math.abs(rawData[i * blockSize + j]);
        }
        peaks.push(sum / blockSize);
      }

      drawWaveform(0);
    }

    // Draw waveform
    function drawWaveform(progress = 0) {
      const width = canvas.width / window.devicePixelRatio;
      const height = canvas.height / window.devicePixelRatio;
      ctx.clearRect(0, 0, width, height);

      const barWidth = width / peaks.length;
      const midY = height / 2;

      peaks.forEach((amp, i) => {
        const x = i * barWidth;
        const barHeight = amp * height * 0.9;
        const isPlayed = (i / peaks.length) < progress;
        ctx.fillStyle = isPlayed ? "#555" : "#ccc";
        ctx.fillRect(x, midY - barHeight / 2, barWidth * 0.9, barHeight);
      });
    }

    // Play / Pause
    playPauseBtn.addEventListener("click", () => {
      if (sound.playing()) {
        sound.pause();
        playPauseBtn.textContent = "‚ñ∂Ô∏è Play";
      } else {
        sound.play();
        playPauseBtn.textContent = "‚è∏ Pause";
      }
    });

    // Update progress
    function updateProgress() {
      clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        if (!sound.playing()) {
          clearInterval(progressInterval);
          return;
        }
        const seek = sound.seek();
        const dur = sound.duration();
        const progress = seek / dur;

        currentTimeEl.textContent = formatTime(seek);
        drawWaveform(progress);
      }, 200);
    }

    // Click to seek
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const progress = clickX / rect.width;
      sound.seek(progress * sound.duration());
      drawWaveform(progress);
    });

    // Volume and speed
    volumeSlider.addEventListener("input", () => sound.volume(parseFloat(volumeSlider.value)));
    speedSlider.addEventListener("input", () => sound.rate(parseFloat(speedSlider.value)));
  </script>
</body>
</html>
